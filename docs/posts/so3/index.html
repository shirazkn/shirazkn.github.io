<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Integration on SO(3) | Shiraz</title>
<meta name="keywords" content="Differential Geometry">
<meta name="description" content="I will construct the Haar measure for SO(3) and pull it back to the axis-angle parametrization of orthogonal matrices. The goal is to be able to integrate (and thereby define probability densities) on SO(3).">
<meta name="author" content="">
<link rel="canonical" href="http://10.0.0.26:1313/posts/so3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.714beb9e60d8ed0531b78e01eacc2e1a3e3fb3a790b8452005202c5e4ab1c2ed.css" integrity="sha256-cUvrnmDY7QUxt44B6swuGj4/s6eQuEUgBSAsXkqxwu0=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://10.0.0.26:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://10.0.0.26:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://10.0.0.26:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://10.0.0.26:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://10.0.0.26:1313/favicon.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://10.0.0.26:1313/posts/so3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><script>
(function() {
    var pref = localStorage.getItem("pref-theme");
    if (pref === "dark" || (!pref && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
        document.documentElement.classList.add("dark");
    }
})();
</script>

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      packages: {'[+]': ['mathtools', 'amscd']},
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]  
    },
    loader:{
      load: ['ui/safe', '[tex]/mathtools', '[tex]/amscd']
    },
  };
</script>

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IM+Fell+DW+Pica">

<meta property="og:url" content="http://10.0.0.26:1313/posts/so3/">
  <meta property="og:site_name" content="Shiraz">
  <meta property="og:title" content="Integration on SO(3)">
  <meta property="og:description" content="I will construct the Haar measure for SO(3) and pull it back to the axis-angle parametrization of orthogonal matrices. The goal is to be able to integrate (and thereby define probability densities) on SO(3).">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-07T11:27:55-04:00">
    <meta property="article:modified_time" content="2024-06-07T11:27:55-04:00">
    <meta property="article:tag" content="Differential Geometry">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Integration on SO(3)">
<meta name="twitter:description" content="I will construct the Haar measure for SO(3) and pull it back to the axis-angle parametrization of orthogonal matrices. The goal is to be able to integrate (and thereby define probability densities) on SO(3).">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://10.0.0.26:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Integration on SO(3)",
      "item": "http://10.0.0.26:1313/posts/so3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Integration on SO(3)",
  "name": "Integration on SO(3)",
  "description": "I will construct the Haar measure for SO(3) and pull it back to the axis-angle parametrization of orthogonal matrices. The goal is to be able to integrate (and thereby define probability densities) on SO(3).",
  "keywords": [
    "Differential Geometry"
  ],
  "articleBody": "I will construct the Haar measure for $SO(3)$ and pull it back to the axis-angle parametrization of orthogonal matrices. The goal is to be able to integrate (and thereby define probability densities) on $SO(3)$. My earlier post on the Riemannian volume form is a prerequisite, though you could also just skip over any equations involving exterior calculus (marked by the use of the ‚Äú$\\wedge$‚Äù symbol) and focus on the bigger picture. The appendix of my preprint also explains integration on Lie groups.\nThe Riemannian Volume Form ü™ê Let the basis for $\\mathfrak{so}(3)$ be given by\n\\[ \\begin{align*} \\tilde E_1 \u0026= \\begin{bmatrix} 0 \u0026 0 \u0026 0 \\\\ 0 \u0026 0 \u0026 -1 \\\\ 0 \u0026 1 \u0026 0 \\end{bmatrix} \\\\ \\tilde E_2 \u0026= \\begin{bmatrix} 0 \u0026 0 \u0026 1 \\\\ 0 \u0026 0 \u0026 0 \\\\ -1 \u0026 0 \u0026 0 \\end{bmatrix} \\\\ \\tilde E_3 \u0026= \\begin{bmatrix} 0 \u0026 -1 \u0026 0 \\\\ 1 \u0026 0 \u0026 0 \\\\ 0 \u0026 0 \u0026 0 \\end{bmatrix} \\end{align*} \\] and the corresponding dual basis of $\\mathfrak{so}(3)^*$ be given by $\\lbrace \\tilde \\varepsilon^1, \\tilde \\varepsilon^2, \\tilde \\varepsilon^3\\rbrace$, where we recall that $\\tilde \\varepsilon^i$ is like the `row vector‚Äô counterpart to $E_i$. In particular, $\\tilde \\varepsilon^i(\\tilde E_j) = \\delta_{ij}$. As usual, we will push these vectors and covectors around using the left-multiplication maps of the group to generate $\\lbrace E_i\\rbrace_{i=1}^3$ and $\\lbrace \\varepsilon^i\\rbrace_{i=1}^3$. Once again, $\\varepsilon^i(E_j) = \\delta_{ij}$, but now $\\delta_{ij}$ must be thought of as a smooth function on $SO(3)$ that is constant-valued.\nThis choice of basis is actually rather special . If we say that this basis is orthonormal (thereby implicitly defining a left-invariant Riemannian metric on $SO(3)$), the corresponding Riemannian metric happens to be right-invariant, and thus, bi-invariant. These invariance properties extend to the corresponding Haar measure . The Haar measure is (up to scaling) the canonical Riemannian volume form1\n$$ \\mu = \\textrm c\\cdot \\varepsilon^1\\wedge\\varepsilon^2\\wedge\\varepsilon^3 $$ In the Lie group sense, $\\mu$ may be considered to be the \"canonical\" volume form (up to a choice of scaling) since it respects the group structure. In the Riemannian geometric sense, $\\mu$ is only \"canonical\" after we have first chosen a metric on $SO(3)$, namely the bi-invariant metric defined by $\\lbrace E_i\\rbrace_{i=1}^3$. where $\\textrm c\\in \\mathbb R_{\u003e0}$ is a normalizing constant that can be chosen such that\n$$ \\int_{SO(3)}\\mu = 1. $$This normalization procedure makes sense precisely because $SO(3)$ is a compact manifold; we cannot normalize the Haar measure of, say, $SE(3)$, and must instead make do with an arbitrary choice of scaling. Note that $\\mu$ is also a probability measure and defines a ‚Äòuniform distribution‚Äô over the space of rotations.\nAs an engineer, my goal is to do calculations involving $\\mu$. Sadly, this often requires us to step away from the intrinsic formulation and work with coordinate charts instead. The good news is that we can come back to the intrinsic formulation when we want to prove theorems and do manipulations that are intrinsic to $SO(3)$. It is important to remember that the coordinate-based approach that we will embark on will be oblivious to many of the topological and group-theoretic properties of $SO(3)$.\nAxis-Angle Parametrization ü™ê Recall that any rotation of $\\mathbb R^3$ is given by an axis and an angle of rotation. These are represented by tuples of the form $(\\mathbf u, \\theta)$, where $\\mathbf u\\in S^2\\subseteq \\mathbb R^3$ is a unit vector2 and $\\theta\\in [0, \\pi]$. This gives the axis-angle parametrization of $SO(3)$:\n\\[ \\begin{align*} \\exp^\\wedge:\\ S^2\\times [0, \\pi] \u0026\\to SO(3) \\\\ (\\mathbf u, \\theta) \u0026\\mapsto \\exp\\big(\\theta\\, \\mathbf u^\\wedge\\big) \\end{align*} \\] where $\\mathbf u^\\wedge$ denotes the skew-symmetric matrix corresponding to $\\mathbf u$ (and has nothing to do with the big wedge ‚Äò$\\wedge$‚Äô operation from earlier). We have something even better; the Cayley-Hamilton theorem can be used to simplify the infinite series involved in matrix exponentiation, and so the axis-angle parametrization can be written as\n$$ \\exp^\\wedge(\\mathbf u, \\theta) = \\mathbf I + (\\sin\\theta) \\,\\mathbf u^\\wedge + (1-\\cos\\theta) \\left(\\mathbf u^\\wedge\\right)^2 $$which is known to some as the Rodriguez map.\nGenerally, the maps $(\\ \\cdot\\ )^\\wedge$ and $(\\ \\cdot\\ )^\\vee$ refer to the linear isomorphism between $\\mathbb R^n$ and $\\mathfrak{g}$ as vector spaces, with $\\mathbf u^\\wedge~=~u^i~\\tilde E_i$. In the case of $\\mathfrak{so}(3)$, the Lie bracket is related to the cross product of $\\mathbb R^3$: \\[ [\\mathbf u^\\wedge, \\mathbf v^\\wedge] = (\\mathbf u \\times \\mathbf v)^\\wedge \\] and so is in fact a Lie algebra isomorphism. The following trick will greatly simplify our presentation. What prevents us from calling the above as the axis-angle coordinates (as opposed to parametrization) is that it fails to be bijective when $\\theta = 0$ and $\\theta = \\pi$; all $0$-angle rotations are the same regardless of the axis of rotation, and $\\pi$-angle rotations about $\\mathbf u$ and $-\\mathbf u$ are the same rotation. Either case, $\\theta = 0$ and $\\theta = \\pi$, determines a $2$-dimensional submanifold of $S^2\\times [0, \\pi]$:\n$S^2\\times [0, \\pi]$ is (homeomorphic to) a thick spherical shell and $\\exp^\\wedge$ maps this shell onto $SO(3)$. Of course, I have greatly exaggerated the hole at the origin. This is because I want to emphasize the topological (rather than geometric) aspects of the axis-angle parametrization. The $\\exp^\\wedge$ map (i) glues the inner surface of this shell into a single point, and (ii) glues together each pair of antipodal points on the outer surface. So, while the image of the $\\theta = 0$ points is a single point in $SO(3)$ (namely, the identity element $e\\in G$), the image of the $\\theta = \\pi$ points is a $2$-dimensional submanifold of $SO(3)$ (consisting of all the rotations by $\\pi$). The aforementioned trick which we will use is that these lower-dimensional sets have measure zero under $\\mu$, so we can peel them away from the spherical shell before doing integration and probability. No longer would we have an obstruction to bijectivity.\nWe thus get a coordinate map $\\psi: U\\rightarrow \\widetilde{SO(3)}$, where $\\widetilde{SO(3)}$ is $SO(3)$ with $e$ and the $\\pi$-rotations removed. The set $U$ is the interior of the ball of radius $\\pi$ in $\\mathbb R^3$ with the origin removed, and is diffeomorphic to $S^2\\times (0, \\pi)$. With some more care, it can be shown that $\\psi$ is itself a diffeomorphism, so that we can think about pulling back the Riemannian structure of $\\widetilde{SO(3)}$ through $\\psi$, establishing an isometry between $U$ and $SO(3)$3. In other words, we are going to talk about how the set $U$ must be morphed and squished for it to accurately represent the geometry of $SO(3)$ (equipped with its bi-invariant measure).\nPulling üîô the Volume Form The coordinate chart $U$ lets us use integration in $\\mathbb R^3$ as a substitute for integration in $SO(3)$:4\n\\[ \\begin{align*} \\int_{SO(3)} \\mu \u0026= \\int_{\\psi^{-1}\\big(\\widetilde{SO}(3)\\big)} \\psi^*\\mu\\\\ \u0026= \\int_{U} \\psi^*\\mu \\end{align*} \\] Consider the standard frame of $U\\subseteq \\mathbb R^3$, $\\lbrace \\frac{\\partial}{\\partial x^i}\\rbrace_{i=1}^3$, and its dual coframe $\\lbrace dx^i\\rbrace_{i=1}^3$. Any $3$ form in $U$ (and in particular, $\\psi^*\\mu$) can be expressed as $f\\ dx^1 \\wedge dx^2 \\wedge dx^3$, where $f\\in C^\\infty(U)$ is a smooth function. Using Lemma 14.16 of Intro. to Smooth Manifolds,5\n\\[ \\psi^*\\mu = \\textrm c\\ (\\psi^*\\varepsilon ^1)\\wedge (\\psi^*\\varepsilon ^2)\\wedge (\\psi^*\\varepsilon ^3) \\] whereas the pullback $\\psi^*\\varepsilon ^i$ is given by\n\\[ \\big[\\psi^*\\varepsilon ^i\\big]\\Big(\\frac{\\partial}{\\partial x^j} \\Big) =\\varepsilon ^i\\Big(\\psi_* \\frac{\\partial}{\\partial x^j} \\Big) \\] Actually, we will sneak in the definition of $\\varepsilon^i$ here; since $\\mu$ itself is defined via a pullback, we will do both of these pullbacks (from $e$ to $g$, and then from $g$ to $\\psi^{-1}(g)$) in tandem6:\n\\[ \\begin{align*} \\big[\\psi^*\\varepsilon ^i\\big]\\Big(\\frac{\\partial}{\\partial x^j} \\Big) \u0026=\\big[\\psi^* (\\mathcal L_{g^{-1}})^*\\tilde \\varepsilon ^i\\big]\\Big(\\frac{\\partial}{\\partial x^j} \\Big) \\\\ \u0026=\\big[(\\mathcal L_{g^{-1}} \\circ \\psi)^*\\tilde \\varepsilon ^i\\big]\\Big(\\frac{\\partial}{\\partial x^j} \\Big)\\\\ \u0026= \\tilde \\varepsilon ^i \\Big((\\mathcal L_{g^{-1}} \\circ \\psi)_*\\frac{\\partial}{\\partial x^j} \\Big) \\end{align*} \\] So, Proposition 14.9 can be used to yield\n\\[ \\psi^*\\mu = \\textrm c\\ \\textrm{det}(???) \\] See John M Lee‚Äôs Introduction to Riemannian Manifolds for an explanation of the term ‚Äúcanonical Riemannian volume form‚Äù.¬†‚Ü©Ô∏é\n$S^2$ is the $2$-sphere in $\\mathbb R^3$, and the ‚Äò$2$‚Äô refers to the fact that it is $2$-dimensional as a manifold.¬†‚Ü©Ô∏é\n$\\widetilde{SO}(3)$ is viewed as a Riemannian submanifold of $SO(3)$, $U$ is viewed as a smooth submanifold of $\\mathbb R^3$ (no metric/measure is imposed on $U$ a priori).¬†‚Ü©Ô∏é\nSee eq. ($16.1$) in Introduction to Smooth Manifolds by John M Lee. ‚Äì\u003e¬†‚Ü©Ô∏é\nI don‚Äôt apply Proposition 14.20 of Lee here since $(\\varepsilon^i)_{i=1}^3$ are not a coordinate coframe. Nonetheless, we recover in this post a similar result for a non-coordinate frame.¬†‚Ü©Ô∏é\nThis is eq. (12.3) of Stochastic Models‚Ä¶Volume 2 by G.S. Chirikjian.¬†‚Ü©Ô∏é\n",
  "wordCount" : "1404",
  "inLanguage": "en",
  "datePublished": "2024-06-07T11:27:55-04:00",
  "dateModified": "2024-06-07T11:27:55-04:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://10.0.0.26:1313/posts/so3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Shiraz",
    "logo": {
      "@type": "ImageObject",
      "url": "http://10.0.0.26:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://10.0.0.26:1313/" accesskey="h" title="Shiraz (Alt + H)">Shiraz</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://10.0.0.26:1313/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="http://10.0.0.26:1313/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="http://10.0.0.26:1313/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Integration on SO(3)
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-meta"><span title='2024-06-07 11:27:55 -0400 EDT'>June 7, 2024</span>

</div>
  </header> 
  <div class="post-content"><p>I will construct the Haar measure for $SO(3)$ and pull it back to the axis-angle parametrization of orthogonal matrices. The goal is to be able to integrate (and thereby define probability densities) on $SO(3)$.
My <a href="/posts/lie-groups_riemannian" class="accented">
    earlier post
</a> on the Riemannian volume form is a prerequisite, though you could also just skip over any equations involving exterior calculus (marked by the use of the &ldquo;$\wedge$&rdquo; symbol) and focus on the bigger picture. The appendix of my <a href="https://arxiv.org/abs/2508.12030" target="_blank" class="accented">
    preprint
</a> also explains integration on Lie groups.</p>
<h2 id="the-riemannian-volume-form-">The Riemannian Volume Form ü™ê<a hidden class="anchor" aria-hidden="true" href="#the-riemannian-volume-form-">#</a></h2>
<p>Let the basis for $\mathfrak{so}(3)$ be given by</p>
<p>
\[
\begin{align*}
\tilde E_1 &= \begin{bmatrix} 0 & 0 & 0 \\ 0 & 0 & -1 \\ 0 & 1 & 0 
\end{bmatrix} \\
\tilde E_2 &= \begin{bmatrix} 0 & 0 & 1 \\ 0 & 0 & 0 \\ -1 & 0 & 0 
\end{bmatrix} \\
\tilde E_3 &= \begin{bmatrix} 0 & -1 & 0 \\ 1 & 0 & 0 \\ 0 & 0 & 0 
\end{bmatrix}
\end{align*}
\]
</p>
<p>and the corresponding dual basis of $\mathfrak{so}(3)^*$ be given by $\lbrace \tilde \varepsilon^1, \tilde  \varepsilon^2, \tilde  \varepsilon^3\rbrace$, where we recall that $\tilde \varepsilon^i$ is like the `row vector&rsquo; counterpart to $E_i$. In particular, $\tilde \varepsilon^i(\tilde E_j) = \delta_{ij}$. As usual, we will push these vectors and covectors around using the left-multiplication maps of the group to generate $\lbrace E_i\rbrace_{i=1}^3$ and $\lbrace \varepsilon^i\rbrace_{i=1}^3$. Once again, $\varepsilon^i(E_j) = \delta_{ij}$, but now $\delta_{ij}$ must be thought of as a smooth function on $SO(3)$ that is constant-valued.</p>
<p>This choice of basis is actually <a href="https://arxiv.org/abs/2508.12030" target="_blank" class="accented">
    rather special
</a>. If we say that this basis is orthonormal (thereby implicitly defining a left-invariant Riemannian metric on $SO(3)$), the corresponding Riemannian metric happens to be right-invariant, and thus, <span class=accented>bi-invariant</span>. These invariance properties extend to the corresponding <a href="/posts/lie-groups_riemannian" class="accented">
    Haar measure
</a>.
The Haar measure is (up to scaling) the canonical Riemannian volume form<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
$$
\mu = \textrm c\cdot \varepsilon^1\wedge\varepsilon^2\wedge\varepsilon^3
$$<aside class=aside-right>
In the Lie group sense, $\mu$ may be considered to be the "<span id="fnref:1"><a href="#fn:1" class="footnote-ref accented" role="doc-noteref">canonical</a></span>" volume form (up to a choice of scaling) since it respects the group structure. In the Riemannian geometric sense, $\mu$ is only "canonical" after we have first chosen a metric on $SO(3)$, namely the bi-invariant metric defined by $\lbrace E_i\rbrace_{i=1}^3$.
</aside>
<p>where $\textrm c\in \mathbb R_{>0}$ is a normalizing constant that can be chosen such that</p>
$$
\int_{SO(3)}\mu = 1.
$$<p>This normalization procedure makes sense precisely because $SO(3)$ is a compact manifold; we cannot normalize the Haar measure of, say, $SE(3)$, and must instead make do with an arbitrary choice of scaling. Note that $\mu$ is also a <a href="https://en.wikipedia.org/wiki/Probability_measure" target="_blank" class="accented">
    probability measure
</a> and defines a &lsquo;uniform distribution&rsquo; over the space of rotations.</p>
<p>As an engineer, my goal is to do calculations involving $\mu$. Sadly, this often requires us to step away from the intrinsic formulation and work with coordinate charts instead. The good news is that we can come back to the intrinsic formulation when we want to prove theorems and do manipulations that are intrinsic to $SO(3)$. It is important to remember that the coordinate-based approach that we will embark on will be oblivious to many of the topological and group-theoretic properties of $SO(3)$.</p>
<hr>
<h2 id="axis-angle-parametrization-"><a href="https://en.wikipedia.org/wiki/Axis%e2%80%93angle_representation" target="_blank" class="accented">
    Axis-Angle Parametrization
</a> ü™ê</h2>
<p>Recall that any rotation of $\mathbb R^3$ is given by an axis and an angle of rotation. These are represented by tuples of the form $(\mathbf u, \theta)$, where $\mathbf u\in S^2\subseteq \mathbb R^3$ is a unit vector<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> and $\theta\in [0, \pi]$. This gives the axis-angle parametrization of $SO(3)$:</p>
<p>
\[
   \begin{align*}
   \exp^\wedge:\  S^2\times [0, \pi] &\to SO(3) \\
   (\mathbf u, \theta) &\mapsto \exp\big(\theta\, \mathbf u^\wedge\big)
    \end{align*}
\] 
</p>
<p>where $\mathbf u^\wedge$ denotes the skew-symmetric matrix corresponding to $\mathbf u$ (and has nothing to do with the big wedge &lsquo;$\wedge$&rsquo; operation from earlier). We have something even better; the Cayley-Hamilton theorem can be used to simplify the infinite series involved in matrix exponentiation, and so the axis-angle parametrization can be written as</p>
$$
\exp^\wedge(\mathbf u, \theta) = \mathbf I + (\sin\theta) \,\mathbf u^\wedge + (1-\cos\theta) \left(\mathbf u^\wedge\right)^2
$$<p>which is known to some as the <span class=accented>Rodriguez map</span>.</p>
<aside class=aside-right>
Generally, the maps $(\ \cdot\ )^\wedge$ and $(\ \cdot\ )^\vee$ refer to the linear isomorphism between $\mathbb R^n$ and $\mathfrak{g}$ as vector spaces, with $\mathbf u^\wedge~=~u^i~\tilde E_i$. In the case of $\mathfrak{so}(3)$, the Lie bracket is related to the cross product of $\mathbb R^3$: 
<p>
\[
[\mathbf u^\wedge, \mathbf v^\wedge] = (\mathbf u \times \mathbf v)^\wedge
\]
</p>
and so is in fact a Lie algebra isomorphism.
</aside>
<p>The following trick will greatly simplify our presentation. What prevents us from calling the above as the axis-angle <em>coordinates</em> (as opposed to <em>parametrization</em>) is that it fails to be bijective when $\theta = 0$ and $\theta = \pi$; all $0$-angle rotations are the same regardless of the axis of rotation, and $\pi$-angle rotations about $\mathbf u$ and $-\mathbf u$ are the same rotation. Either case, $\theta = 0$ and $\theta = \pi$, determines a $2$-dimensional submanifold of $S^2\times [0, \pi]$:</p>
<figure class=invertible style="max-width: 100%;">
<img src=/post-images/lie_groups/so3.png>
<figcaption>$S^2\times [0, \pi]$ is (homeomorphic to) a thick spherical shell</figcaption>
</figure>
<p>and $\exp^\wedge$ maps this shell onto $SO(3)$.
Of course, I have greatly exaggerated the hole at the origin. This is because I want to emphasize the topological (rather than geometric) aspects of the axis-angle parametrization.
The $\exp^\wedge$ map (i) glues the inner surface of this shell into a single point, and (ii) glues together each pair of antipodal points on the outer surface.
So, while the image of the $\theta = 0$ points is a single point in $SO(3)$ (namely, the identity element $e\in G$), the image of the $\theta = \pi$ points is a $2$-dimensional submanifold of $SO(3)$ (consisting of all the rotations by $\pi$).
The aforementioned <em>trick</em> which we will use is that these lower-dimensional sets have measure zero under $\mu$, so we can peel them away from the spherical shell before doing integration and probability. No longer would we have an obstruction to bijectivity.</p>
<p>We thus get a coordinate map $\psi: U\rightarrow \widetilde{SO(3)}$, where $\widetilde{SO(3)}$ is $SO(3)$ with $e$ and the $\pi$-rotations removed. The set $U$ is the interior of the ball of radius $\pi$ in $\mathbb R^3$ with the origin removed, and is diffeomorphic to $S^2\times (0, \pi)$.
With some more care, it can be shown that $\psi$ is itself a diffeomorphism, so that we can think about pulling back the Riemannian structure of $\widetilde{SO(3)}$ through $\psi$, establishing an isometry between $U$ and $SO(3)$<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. In other words, we are going to talk about how the set $U$ must be morphed and squished for it to accurately represent the geometry of $SO(3)$ (equipped with its bi-invariant measure).</p>
<h3 id="pulling--the-volume-form">Pulling <span style="color:transparent; text-shadow: 0 0 0 var(--primary);">üîô</span> the Volume Form<a hidden class="anchor" aria-hidden="true" href="#pulling--the-volume-form">#</a></h3>
<p>The coordinate chart $U$ lets us use integration in $\mathbb R^3$ as a substitute for integration in $SO(3)$:<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></p>
<p>
\[
\begin{align*}
\int_{SO(3)} \mu &=  \int_{\psi^{-1}\big(\widetilde{SO}(3)\big)} \psi^*\mu\\
&= \int_{U} \psi^*\mu 
\end{align*}
\]
</p>
<p>Consider the standard frame of $U\subseteq \mathbb R^3$, $\lbrace \frac{\partial}{\partial x^i}\rbrace_{i=1}^3$, and its dual coframe $\lbrace dx^i\rbrace_{i=1}^3$.
Any $3$ form in $U$ (and in particular, $\psi^*\mu$) can be expressed as $f\ dx^1 \wedge dx^2 \wedge dx^3$, where $f\in C^\infty(U)$ is a smooth function. Using Lemma 14.16 of Intro. to Smooth Manifolds,<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<p>
\[
\psi^*\mu = \textrm c\ (\psi^*\varepsilon ^1)\wedge (\psi^*\varepsilon ^2)\wedge (\psi^*\varepsilon ^3)
\]
</p>
<p>whereas the pullback $\psi^*\varepsilon ^i$ is given by</p>
<p>
\[
    \big[\psi^*\varepsilon ^i\big]\Big(\frac{\partial}{\partial x^j} \Big) 
    =\varepsilon ^i\Big(\psi_* \frac{\partial}{\partial x^j} \Big)
    \]
    </p>
<p>Actually, we will sneak in the definition of $\varepsilon^i$ here; since $\mu$ itself is defined via a pullback, we will do both of these pullbacks (from $e$ to $g$, and then from $g$ to $\psi^{-1}(g)$) in tandem<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>:</p>
<p>
\[
    \begin{align*}
    \big[\psi^*\varepsilon ^i\big]\Big(\frac{\partial}{\partial x^j} \Big) 
    &=\big[\psi^* (\mathcal L_{g^{-1}})^*\tilde \varepsilon ^i\big]\Big(\frac{\partial}{\partial x^j} \Big) \\
    &=\big[(\mathcal L_{g^{-1}} \circ \psi)^*\tilde \varepsilon ^i\big]\Big(\frac{\partial}{\partial x^j} \Big)\\
    &= \tilde \varepsilon ^i \Big((\mathcal L_{g^{-1}} \circ \psi)_*\frac{\partial}{\partial x^j} \Big)
   \end{align*}
\]
</p>
<p>So, Proposition 14.9 can be used to yield</p>
<p>
\[
    \psi^*\mu = \textrm c\ \textrm{det}(???)
    \]
    </p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>See John M Lee&rsquo;s <em>Introduction to Riemannian Manifolds</em> for an explanation of the term &ldquo;canonical Riemannian volume form&rdquo;.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>$S^2$ is the $2$-sphere in $\mathbb R^3$, and the &lsquo;$2$&rsquo; refers to the fact that it is $2$-dimensional as a manifold.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>$\widetilde{SO}(3)$ is viewed as a Riemannian submanifold of $SO(3)$, $U$ is viewed as a smooth submanifold of $\mathbb R^3$ (no metric/measure is imposed on $U$ <em>a priori</em>).&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>See eq. ($16.1$) in <em>Introduction to Smooth Manifolds</em> by John M Lee. &ndash;&gt;&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>I don&rsquo;t apply Proposition 14.20 of Lee here since $(\varepsilon^i)_{i=1}^3$ are not a coordinate coframe. Nonetheless, we recover in this post a similar result for a non-coordinate frame.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>This is eq. (12.3) of <em>Stochastic Models&hellip;Volume 2</em> by G.S. Chirikjian.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://10.0.0.26:1313/tags/differential-geometry/">Differential Geometry</a></li>
    </ul>
  </footer>
<script src="https://giscus.app/client.js"
        data-repo="shirazkn/shirazkn.github.io"
        data-repo-id="R_kgDOI2VbWw"
        data-category="Announcements"
        data-category-id="DIC_kwDOI2VbW84CWJnt"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="noborder_light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
    
    
    
    
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script>

document.addEventListener('touchstart', function() {}, { passive: true });


function syncDarkClass() {
    const isDark = document.documentElement.dataset.theme === 'dark';
    document.documentElement.classList.toggle('dark', isDark);
    document.body.classList.toggle('dark', isDark);
}
syncDarkClass();


const themeToggle = document.getElementById('theme-toggle');
if (themeToggle) {
    themeToggle.addEventListener('click', () => {
        setTimeout(syncDarkClass, 0);
    });
}


document.querySelectorAll('.logo a, .post-title').forEach(el => {
    el.innerHTML = el.textContent.trim().split(' ').map(word =>
        `<span class="hover-word">${word.split('').map(char =>
            `<span class="hover-letter">${char}</span>`
        ).join('')}</span>`
    ).join(' ');
});


const isDark = () => document.body.classList.contains('dark');
const hoverColorsDark = ['#ff51af', '#ff51af', '#f161ac', '#f161ac', '#db327e', '#db327e', '#3b82f6', '#38bdf8'];
const hoverColorsLight = ['#ff51af', '#ff51af', '#e83a89', '#e83a89', '#f542a1', '#d6306f', '#3b9eff', '#00c2ff'];
const getHoverColors = () => isDark() ? hoverColorsDark : hoverColorsLight;
document.querySelectorAll('.hover-letter').forEach(letter => {
    letter.addEventListener('mouseenter', () => {
        const colors = getHoverColors();
        letter.style.color = colors[Math.floor(Math.random() * colors.length)];
    });
    letter.addEventListener('mouseleave', () => {
        letter.style.color = '';
    });
});


let scanInProgress = false;
const scanElement = (el) => {
    if (scanInProgress) return;
    scanInProgress = true;
    const letters = el.querySelectorAll('.hover-letter');
    const colors = getHoverColors();
    const totalTime = letters.length * 50 + 100;
    letters.forEach((letter, i) => {
        setTimeout(() => {
            letter.style.transition = 'top 0.05s ease-out, color 0s';
            letter.style.color = colors[Math.floor(Math.random() * colors.length)];
            letter.style.top = '-0.08em';
            setTimeout(() => {
                letter.style.transition = '';
                letter.style.color = '';
                letter.style.top = '';
            }, 100);
        }, i * 50);
    });
    setTimeout(() => { scanInProgress = false; }, totalTime);
};

let lastScannedEl = null;
const triggerRandomScan = () => {
    const logos = Array.from(document.querySelectorAll('.logo a'));
    const titles = Array.from(document.querySelectorAll('.post-title'));
    
    const pickLogo = Math.random() < 0.5 && logos.length > 0;
    let elements = pickLogo ? logos : titles;
    
    if (lastScannedEl && elements.length > 1) {
        elements = elements.filter(el => el !== lastScannedEl);
    }
    if (elements.length > 0) {
        const el = elements[Math.floor(Math.random() * elements.length)];
        lastScannedEl = el;
        scanElement(el);
    }
    
    setTimeout(triggerRandomScan, 4000 + Math.random() * 6000);
};


const isHomePage = document.querySelector('.first-entry.home-info') !== null;





const CARD_CONFIG = {
    
    hoverLift: 4,
    
    maxRotation: 0.8,
    
    shadowOpacityLight: 0.22,      
    shadowOpacityDark: 0.45,       
    shadowOpacityRange: 0.12,      
    
    shadowBlurBase: 1.5,           
    shadowBlurHover: 2.5,          
    shadowYOffsetBase: 1,          
    shadowYOffsetHover: 2,         
};



const postCards = document.querySelectorAll('.post-entry');
const isTouchDevice = window.matchMedia('(pointer: coarse)').matches;

if (isTouchDevice && window.isSecureContext && 'DeviceOrientationEvent' in window) {
    
    
    let gyroBaselineBeta = null;
    let gyroBaselineGamma = null;
    const GYRO_DRIFT_RATE_MIN = 0.002;  
    const GYRO_DRIFT_RATE_MAX = 0.25;   
    let gyroRafId = null;
    let latestBeta = null, latestGamma = null;
    let cardGyroPermissionRequested = false;

    
    let currentRotateX = 0, currentRotateY = 0;
    let currentTranslateX = 0, currentTranslateY = 0;

    
    let cardFocusValues = new Array(postCards.length).fill(0);
    let transformRafId = null;

    
    function scheduleTransformUpdate() {
        if (transformRafId) return;
        transformRafId = requestAnimationFrame(() => {
            applyCardTransforms();
            transformRafId = null;
        });
    }

    
    const observerThresholds = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];
    const cardObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const index = Array.prototype.indexOf.call(postCards, entry.target);
            if (index === -1) return;

            
            const ratio = entry.intersectionRatio;
            
            cardFocusValues[index] = ratio * ratio;
        });
        scheduleTransformUpdate();
    }, {
        threshold: observerThresholds,
        
        rootMargin: '-15% 0px -15% 0px'
    });

    
    postCards.forEach(card => cardObserver.observe(card));

    function applyCardTransforms() {
        
        const baseGyroX = currentRotateX * 0.3;
        const baseGyroY = currentRotateY * 0.3;
        const gyroRangeX = currentRotateX * 0.7;
        const gyroRangeY = currentRotateY * 0.7;
        
        const baseTransX = currentTranslateX * 0.3;
        const baseTransY = currentTranslateY * 0.3;
        const transRangeX = currentTranslateX * 0.7;
        const transRangeY = currentTranslateY * 0.7;

        for (let i = 0; i < postCards.length; i++) {
            const focus = cardFocusValues[i];
            const card = postCards[i];

            
            const rotX = baseGyroX + gyroRangeX * focus;
            const rotY = baseGyroY + gyroRangeY * focus;
            const transX = baseTransX + transRangeX * focus;
            const transY = baseTransY + transRangeY * focus;

            card.style.transform = `perspective(1000px) rotateX(${rotX}deg) rotateY(${rotY}deg) translateX(${transX}px) translateY(${transY}px) scale(${1 + focus * 0.02})`;
            card.style.boxShadow = `0 ${1 + focus * 2}px ${2 + focus * 4}px rgba(0,0,0,${0.3 + focus * 0.3})`;
            card.style.opacity = 0.25 + focus * 0.75;
        }
    }

    function handleCardOrientation(event) {
        if (event.beta === null || event.gamma === null) return;

        
        const orientation = screen.orientation?.angle ?? window.orientation ?? 0;
        let beta, gamma;

        if (orientation === 90) {
            beta = event.gamma;
            gamma = -event.beta;
        } else if (orientation === -90 || orientation === 270) {
            beta = -event.gamma;
            gamma = event.beta;
        } else if (orientation === 180) {
            beta = -event.beta;
            gamma = -event.gamma;
        } else {
            beta = event.beta;
            gamma = event.gamma;
        }

        latestBeta = beta;
        latestGamma = gamma;

        if (!gyroRafId) {
            gyroRafId = requestAnimationFrame(() => {
                
                if (gyroBaselineBeta === null) {
                    gyroBaselineBeta = latestBeta;
                    gyroBaselineGamma = latestGamma;
                }

                
                const relativeBeta = latestBeta - gyroBaselineBeta;
                const relativeGamma = latestGamma - gyroBaselineGamma;

                
                const maxTilt = Math.max(Math.abs(relativeBeta), Math.abs(relativeGamma));
                const tiltFactor = Math.min(1, maxTilt / 30);  
                
                const driftRate = GYRO_DRIFT_RATE_MIN + tiltFactor * tiltFactor * tiltFactor * (GYRO_DRIFT_RATE_MAX - GYRO_DRIFT_RATE_MIN);

                
                gyroBaselineBeta += (latestBeta - gyroBaselineBeta) * driftRate;
                gyroBaselineGamma += (latestGamma - gyroBaselineGamma) * driftRate;

                
                currentRotateY = Math.max(-8, Math.min(8, relativeGamma * 0.35));
                currentRotateX = Math.max(-8, Math.min(8, relativeBeta * -0.35));

                
                currentTranslateX = Math.max(-6, Math.min(6, relativeGamma * 0.22));
                currentTranslateY = Math.max(-5, Math.min(5, relativeBeta * 0.18));

                scheduleTransformUpdate();
                gyroRafId = null;
            });
        }
    }

    function enableCardGyroscope() {
        window.addEventListener('deviceorientation', handleCardOrientation, { passive: true });
    }

    
    applyCardTransforms();

    
    postCards.forEach((card, index) => {
        let touchStartTime = 0;

        card.addEventListener('touchstart', (e) => {
            touchStartTime = Date.now();
            const focus = cardFocusValues[index];
            
            card.style.transition = 'transform 0.08s ease-out, box-shadow 0.08s ease-out';
            card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale(${0.97 + focus * 0.01})`;
            card.style.boxShadow = `0 0.5px 1px rgba(0,0,0,0.2)`;
        }, { passive: true });

        card.addEventListener('touchend', () => {
            
            card.style.transition = 'transform 0.15s ease-out, box-shadow 0.15s ease-out';
            setTimeout(() => {
                card.style.transition = '';
                scheduleTransformUpdate();
            }, 150);
        }, { passive: true });

        card.addEventListener('touchcancel', () => {
            card.style.transition = '';
            scheduleTransformUpdate();
        }, { passive: true });
    });

    
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        
        enableCardGyroscope();

        
        const requestPermission = () => {
            if (cardGyroPermissionRequested) return;
            cardGyroPermissionRequested = true;

            DeviceOrientationEvent.requestPermission()
                .then(state => {
                    if (state === 'granted') {
                        enableCardGyroscope();
                    }
                })
                .catch(() => {
                    cardGyroPermissionRequested = false;
                });
        };
        document.addEventListener('touchstart', requestPermission, { once: true, passive: true });
        document.addEventListener('touchend', requestPermission, { once: true, passive: true });
        document.addEventListener('click', requestPermission, { once: true, passive: true });
    } else {
        
        enableCardGyroscope();
    }
} else {
    
    
    let currentMouseCard = null;
    let lastMouseX = 0, lastMouseY = 0;

    postCards.forEach(card => {
        let rafId = null;
        let isPressed = false;

        card.addEventListener('mouseenter', () => {
            currentMouseCard = card;
        });

        card.addEventListener('mousemove', (e) => {
            if (isPressed) return; 
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;

            if (!rafId) {
                rafId = requestAnimationFrame(() => {
                    if (isPressed) { rafId = null; return; }
                    const rect = card.getBoundingClientRect();
                    const mouseX = lastMouseX - rect.left;
                    const mouseY = lastMouseY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = (mouseY - centerY) / centerY * -CARD_CONFIG.maxRotation;
                    const rotateY = (mouseX - centerX) / centerX * CARD_CONFIG.maxRotation;
                    const normalizedY = (centerY - mouseY) / centerY;
                    const isDarkMode = document.body.classList.contains('dark');
                    const baseOpacity = isDarkMode ? CARD_CONFIG.shadowOpacityDark : CARD_CONFIG.shadowOpacityLight;
                    const shadowOpacity = Math.max(0, baseOpacity + normalizedY * CARD_CONFIG.shadowOpacityRange);
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(${CARD_CONFIG.hoverLift}px)`;
                    card.style.boxShadow = `0 ${CARD_CONFIG.shadowYOffsetHover}px ${CARD_CONFIG.shadowBlurHover}px rgba(0, 0, 0, ${shadowOpacity})`;
                    rafId = null;
                });
            }
        });

        card.addEventListener('mousedown', () => {
            isPressed = true;
            card.style.transform = 'scale(0.99)';
            card.style.boxShadow = '';
        });

        card.addEventListener('mouseup', () => {
            isPressed = false;
        });

        card.addEventListener('mouseleave', () => {
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            isPressed = false;
            card.style.transform = '';
            card.style.boxShadow = '';
            currentMouseCard = null;
        });
    });

}

if (isHomePage) {
    
    setTimeout(triggerRandomScan, 3000 + Math.random() * 2000);
} else {
    
    setTimeout(() => {
        const logo = document.querySelector('.logo a');
        if (logo) scanElement(logo);

        setTimeout(() => {
            const titles = Array.from(document.querySelectorAll('.post-title'));
            if (titles.length > 0) {
                scanElement(titles[Math.floor(Math.random() * titles.length)]);
            }
            
            setTimeout(triggerRandomScan, 4000 + Math.random() * 6000);
        }, 400);
    }, 800);
}


const tocBox = document.querySelector('.toc');
if (tocBox) {
    const tocDetails = tocBox.querySelector('details');
    if (tocDetails) {
        tocBox.addEventListener('click', (e) => {
            
            if (e.target.tagName === 'A') return;
            
            if (e.target.closest('summary')) return;
            tocDetails.open = !tocDetails.open;
        });
    }
}
</script>
<div class="headerfooter">
    <sub><sup><sub>..</sub></sup></sub>
</div>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            document.documentElement.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            document.documentElement.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
